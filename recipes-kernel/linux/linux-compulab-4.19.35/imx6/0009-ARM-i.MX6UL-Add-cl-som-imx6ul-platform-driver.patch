From 4fd9887ed687cd189b11a2372b3adf05ca58124c Mon Sep 17 00:00:00 2001
From: Valentin Raevsky <valentin@compulab.co.il>
Date: Fri, 15 Apr 2022 09:19:47 +0300
Subject: [PATCH 09/11] ARM: i.MX6UL: Add cl-som-imx6ul platform driver.

Add cl-som-imx6ul platform driver.
This patch sets a correct value of the ENET1 reference
clock mode selection field (GPR1.13 = 1).
It is required in order to make FEC and PHY work together
with respect to the CompuLab board design.
In cl-som-imx6ul boards, ENET ref clock source is a kzs8041 phy.
Details in the IMX6ULRM.

Signed-off-by: Valentin Raevsky <valentin@compulab.co.il>
---
 arch/arm/mach-imx/Kconfig              |  7 +++
 arch/arm/mach-imx/Makefile             |  1 +
 arch/arm/mach-imx/mach-cl-som-imx6ul.c | 74 ++++++++++++++++++++++++++
 3 files changed, 82 insertions(+)
 create mode 100644 arch/arm/mach-imx/mach-cl-som-imx6ul.c

diff --git a/arch/arm/mach-imx/Kconfig b/arch/arm/mach-imx/Kconfig
index c2e0d126b8f9..d8dac8afb9dc 100644
--- a/arch/arm/mach-imx/Kconfig
+++ b/arch/arm/mach-imx/Kconfig
@@ -581,6 +581,13 @@ config SOC_IMX6ULL
 	help
 	  This enables support for Freescale i.MX6 ULL processor.
 
+config CL_SOM_IMX6UL
+       bool "CompuLab SoM i.MX6ul board support"
+       depends on SOC_IMX6UL
+
+       help
+        This enables support for CompuLab SoM i.MX6ul board.
+
 config SOC_IMX7
 	bool
 	select CPU_V7
diff --git a/arch/arm/mach-imx/Makefile b/arch/arm/mach-imx/Makefile
index 9b6ce989ccb1..9b3bbf475180 100644
--- a/arch/arm/mach-imx/Makefile
+++ b/arch/arm/mach-imx/Makefile
@@ -108,6 +108,7 @@ obj-$(CONFIG_SOC_IMX6SX) += mach-imx6sx.o ddr3_freq_imx6sx.o \
 			    lpddr2_freq_imx6sx.o
 obj-$(CONFIG_SOC_IMX6UL) += mach-imx6ul.o ddr3_freq_imx6sx.o \
 			    lpddr2_freq_imx6sx.o
+obj-$(CONFIG_CL_SOM_IMX6UL) += mach-cl-som-imx6ul.o
 obj-$(CONFIG_SOC_IMX7D) += mach-imx7d.o
 obj-$(CONFIG_SOC_IMX7ULP) += mach-imx7ulp.o pm-imx7ulp.o pm-rpmsg.o
 
diff --git a/arch/arm/mach-imx/mach-cl-som-imx6ul.c b/arch/arm/mach-imx/mach-cl-som-imx6ul.c
new file mode 100644
index 000000000000..8e464a15ee6d
--- /dev/null
+++ b/arch/arm/mach-imx/mach-cl-som-imx6ul.c
@@ -0,0 +1,74 @@
+/*
+ * Copyright (C) 2015 CompuLab LTD. 
+ *
+ * This program is free software; you can redistribute it and/or modify
+ * it under the terms of the GNU General Public License version 2 as
+ * published by the Free Software Foundation.
+ */
+
+#include <linux/of_address.h>
+#include <linux/of_platform.h>
+#include <linux/io.h>
+#include <linux/regmap.h>
+#include <linux/mfd/syscon.h>
+#include <linux/mfd/syscon/imx6q-iomuxc-gpr.h>
+#include <asm/mach/arch.h>
+#include <asm/mach/map.h>
+
+static inline void __init cl_som_imx6ul_enet_clk_init(struct regmap *gpr)
+{
+	regmap_update_bits(gpr, IOMUXC_GPR1, IMX6UL_GPR1_ENET_CLK_DIR, 1<<13);
+}
+
+static inline void __init cl_som_imx6ul_sai2_clk_init(struct regmap *gpr)
+{
+	regmap_update_bits(gpr, IOMUXC_GPR1, 1<<20, 1<<20);
+}
+
+static void __init cl_som_imx6ul_clk_init(void)
+{
+	struct regmap *gpr;
+
+	gpr = syscon_regmap_lookup_by_compatible("fsl,imx6ul-iomuxc-gpr");
+	if (IS_ERR(gpr)) {
+		pr_err("failed to find fsl,imx6ul-iomux-gpr regmap\n");
+		return;
+	}
+	cl_som_imx6ul_enet_clk_init(gpr);
+	cl_som_imx6ul_sai2_clk_init(gpr);
+}
+
+static void __init cl_som_imx6ul_ccm_init(void)
+{
+#define BM_CLPCR_VSTBY			(0x1 << 8)
+#define CLPCR				0x54
+	void __iomem *ccm_base;
+	struct device_node *np;
+	u32 val;
+
+	np = of_find_compatible_node(NULL, NULL, "fsl,imx6ul-ccm");
+	ccm_base = of_iomap(np, 0);
+	BUG_ON(!ccm_base);
+
+	val = readl_relaxed(ccm_base + CLPCR);
+	val |= BM_CLPCR_VSTBY;
+	writel_relaxed(val, ccm_base + CLPCR);
+}
+
+static int __init cl_som_imx6ul_init(void)
+{
+	struct device_node *np;
+
+	np = of_find_compatible_node(NULL, NULL, "compulab,cl-som-imx6ul");
+
+	if (!np) {
+		pr_err("failed to find compulab,cl-som-imx6ul\n");
+		return -ENODEV;
+	}
+
+	cl_som_imx6ul_clk_init();
+	cl_som_imx6ul_ccm_init();
+
+	return 0;
+}
+subsys_initcall(cl_som_imx6ul_init);
-- 
2.17.1

